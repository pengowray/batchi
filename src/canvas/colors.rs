/// Map a spectrogram magnitude to a greyscale pixel value (0-255).
/// Uses log scale (dB) for perceptual brightness.
pub fn magnitude_to_greyscale(mag: f32, max_mag: f32) -> u8 {
    if max_mag <= 0.0 || mag <= 0.0 {
        return 0;
    }
    let db = 20.0 * (mag / max_mag).log10();
    // Clamp to [-80, 0] dB dynamic range
    let db_clamped = db.max(-80.0).min(0.0);
    // Map to 0-255
    ((db_clamped + 80.0) / 80.0 * 255.0) as u8
}

/// Resistor color band colors for frequency markers at 10 kHz intervals.
/// Repeats every 10 decades (0=black, 1=brown, ..., 9=white, 10=black, ...).
pub fn freq_marker_color(freq_hz: f64) -> [u8; 3] {
    const BANDS: [[u8; 3]; 10] = [
        [40, 40, 40],      // 0 - black (lightened for visibility)
        [139, 69, 19],     // 1 - brown
        [255, 0, 0],       // 2 - red
        [255, 165, 0],     // 3 - orange
        [255, 255, 0],     // 4 - yellow
        [0, 128, 0],       // 5 - green
        [0, 0, 255],       // 6 - blue
        [148, 0, 211],     // 7 - violet
        [128, 128, 128],   // 8 - grey
        [255, 255, 255],   // 9 - white
    ];
    let digit = (freq_hz / 10_000.0).round() as u32 % 10;
    BANDS[digit as usize]
}

/// Hermite smoothstep: smooth transition from 0 to 1 between edge0 and edge1.
fn smoothstep(x: f32, edge0: f32, edge1: f32) -> f32 {
    if edge1 <= edge0 {
        return if x >= edge0 { 1.0 } else { 0.0 };
    }
    let t = ((x - edge0) / (edge1 - edge0)).clamp(0.0, 1.0);
    t * t * (3.0 - 2.0 * t)
}

/// Map a greyscale base value and a frequency-shift amount to an RGB triple.
/// `shift` > 0 → energy moving upward in frequency → red tint.
/// `shift` < 0 → energy moving downward in frequency → blue tint.
///
/// Two smooth gates control when color appears:
/// - `intensity_gate` (0.0–1.0): how bright must a pixel be to show color
/// - `movement_gate` (0.0–1.0): how large must the shift be to show color
/// - `opacity` (0.0–1.0): overall color strength multiplier
pub fn movement_rgb(grey: u8, shift: f32, intensity_gate: f32, movement_gate: f32, opacity: f32) -> [u8; 3] {
    let g_norm = grey as f32 / 255.0;

    // Smooth intensity gate: ramp from gate*0.6 to gate*1.4
    let ig_lo = intensity_gate * 0.6;
    let ig_hi = (intensity_gate * 1.4).min(1.0);
    let intensity_factor = smoothstep(g_norm, ig_lo, ig_hi);

    // Smooth movement gate: ramp based on |shift|
    let abs_shift = shift.abs();
    let mg_lo = movement_gate * 0.3;
    let mg_hi = (movement_gate * 2.0).max(0.05);
    let movement_factor = smoothstep(abs_shift, mg_lo, mg_hi);

    let effective = intensity_factor * movement_factor * opacity;
    if effective < 0.001 {
        return [grey, grey, grey];
    }

    let gain: f32 = 3.0;
    let s = (shift * gain * effective).clamp(-1.0, 1.0);
    let g = grey as f32;
    if s > 0.0 {
        // Upward shift → red
        let r = (g + s * (255.0 - g)).min(255.0) as u8;
        let gb = (g * (1.0 - 0.5 * s)).max(0.0) as u8;
        [r, gb, gb]
    } else {
        // Downward shift → blue
        let a = -s;
        let b = (g + a * (255.0 - g)).min(255.0) as u8;
        let rg = (g * (1.0 - 0.5 * a)).max(0.0) as u8;
        [rg, rg, b]
    }
}

/// Label for a frequency marker (number only, e.g. "40").
pub fn freq_marker_label(freq_hz: f64) -> String {
    format!("{}", (freq_hz / 1000.0).round() as u32)
}

/// Apply viridis colormap to a greyscale pixel value (0=dark purple, 255=yellow).
#[inline]
pub fn greyscale_to_viridis(grey: u8) -> [u8; 3] {
    VIRIDIS_LUT[grey as usize]
}

/// Apply inferno colormap to a greyscale pixel value (0=black, 255=pale yellow).
#[inline]
pub fn greyscale_to_inferno(grey: u8) -> [u8; 3] {
    INFERNO_LUT[grey as usize]
}

/// Standard matplotlib viridis perceptual colormap — 256 RGB entries.
pub const VIRIDIS_LUT: [[u8; 3]; 256] = [
    [68,1,84],[68,2,86],[69,4,87],[69,5,89],[70,7,90],[70,8,92],[70,10,93],[70,11,94],
    [71,13,96],[71,14,97],[71,16,99],[71,17,100],[71,19,101],[72,20,103],[72,22,104],[72,23,105],
    [72,24,106],[72,26,108],[72,27,109],[72,28,110],[72,29,111],[72,31,112],[72,32,113],[72,33,115],
    [72,35,116],[72,36,117],[72,37,118],[72,38,119],[72,40,120],[72,41,121],[71,42,122],[71,44,122],
    [71,45,123],[71,46,124],[71,47,125],[70,48,126],[70,50,126],[70,51,127],[69,52,128],[69,53,129],
    [69,55,129],[68,56,130],[68,57,131],[68,58,131],[67,60,132],[67,61,132],[66,62,133],[66,63,133],
    [66,64,134],[65,66,134],[65,67,135],[64,68,135],[64,69,136],[63,71,136],[63,72,137],[62,73,137],
    [62,74,137],[62,76,138],[61,77,138],[61,78,138],[60,79,139],[60,80,139],[59,82,139],[59,83,140],
    [58,84,140],[58,85,140],[57,86,141],[57,88,141],[56,89,141],[56,90,141],[55,91,142],[55,92,142],
    [54,93,142],[54,94,142],[53,96,142],[53,97,142],[52,98,143],[52,99,143],[51,100,143],[51,101,143],
    [50,103,143],[50,104,143],[49,105,143],[49,106,143],[49,107,143],[48,108,143],[48,109,143],[47,110,143],
    [47,111,143],[46,112,143],[46,113,143],[46,114,143],[45,115,143],[45,116,142],[44,117,142],[44,118,142],
    [44,119,142],[43,120,142],[43,121,142],[42,122,142],[42,123,141],[42,124,141],[41,125,141],[41,126,141],
    [41,127,141],[40,128,140],[40,129,140],[40,130,140],[39,131,140],[39,132,139],[39,133,139],[38,134,139],
    [38,135,138],[38,136,138],[37,137,138],[37,138,137],[37,139,137],[36,140,137],[36,141,136],[36,142,136],
    [35,143,135],[35,144,135],[35,145,134],[35,146,134],[34,147,133],[34,148,133],[34,149,132],[33,150,132],
    [33,151,131],[33,152,131],[33,153,130],[33,154,130],[33,155,129],[33,156,128],[33,157,128],[33,158,127],
    [33,159,126],[34,160,126],[34,161,125],[34,162,124],[35,163,124],[35,164,123],[35,165,122],[36,166,122],
    [36,167,121],[37,168,120],[37,169,119],[38,170,119],[39,171,118],[39,172,117],[40,173,116],[41,174,115],
    [42,175,115],[42,176,114],[43,177,113],[44,178,112],[46,179,111],[47,180,110],[48,181,109],[49,182,108],
    [50,183,107],[52,184,106],[53,185,105],[55,186,104],[56,187,103],[58,188,101],[59,189,100],[61,190,99],
    [63,191,98],[64,192,97],[66,193,95],[68,194,94],[70,195,93],[72,196,91],[74,197,90],[76,198,89],
    [78,199,87],[80,200,86],[82,201,84],[84,202,83],[86,203,81],[89,204,80],[91,205,78],[93,206,76],
    [95,207,75],[98,208,73],[100,209,71],[103,210,69],[105,211,68],[108,212,66],[110,213,64],[113,214,62],
    [116,215,60],[118,215,58],[121,216,56],[124,217,54],[127,218,52],[129,219,50],[132,220,48],[135,221,46],
    [138,222,44],[141,222,42],[144,223,40],[147,224,38],[150,225,36],[153,225,33],[156,226,31],[159,227,29],
    [162,228,27],[165,228,25],[168,229,23],[172,230,21],[175,230,19],[178,231,17],[181,232,16],[185,232,14],
    [188,233,12],[191,234,11],[195,234,10],[198,235,9],[201,236,8],[205,236,8],[208,237,8],[211,237,8],
    [215,238,9],[218,238,10],[221,239,11],[225,239,13],[228,240,15],[231,240,17],[235,241,19],[238,241,22],
    [241,242,25],[244,242,28],[247,243,31],[250,243,35],[253,244,38],[253,244,42],[253,245,45],[253,245,49],
    [253,246,53],[253,246,57],[254,247,61],[254,247,65],[254,248,69],[254,248,73],[254,249,78],[254,249,82],
    [254,250,87],[254,250,91],[254,251,96],[254,251,101],[255,252,105],[255,252,110],[255,253,115],[255,253,120],
];

/// Standard matplotlib inferno perceptual colormap — 256 RGB entries.
pub const INFERNO_LUT: [[u8; 3]; 256] = [
    [0,0,3],[0,0,4],[0,0,6],[1,0,7],[1,1,9],[1,1,11],[2,1,14],[2,2,16],
    [3,2,18],[4,3,20],[4,3,22],[5,4,24],[6,4,27],[7,5,29],[8,6,31],[9,6,33],
    [10,7,35],[11,7,38],[13,8,40],[14,8,42],[15,9,45],[16,9,47],[18,10,50],[19,10,52],
    [20,11,54],[22,11,57],[23,11,59],[25,11,62],[26,11,64],[28,12,67],[29,12,69],[31,12,71],
    [32,12,74],[34,11,76],[36,11,78],[38,11,80],[39,11,82],[41,11,84],[43,10,86],[45,10,88],
    [46,10,90],[48,10,92],[50,9,93],[52,9,95],[53,9,96],[55,9,97],[57,9,98],[59,9,100],
    [60,9,101],[62,9,102],[64,9,102],[65,9,103],[67,10,104],[69,10,105],[70,10,105],[72,11,106],
    [74,11,106],[75,12,107],[77,12,107],[79,13,108],[80,13,108],[82,14,108],[83,14,109],[85,15,109],
    [87,15,109],[88,16,109],[90,17,109],[91,17,110],[93,18,110],[95,18,110],[96,19,110],[98,20,110],
    [99,20,110],[101,21,110],[102,21,110],[104,22,110],[106,23,110],[107,23,110],[109,24,110],[110,24,110],
    [112,25,110],[114,25,109],[115,26,109],[117,27,109],[118,27,109],[120,28,109],[122,28,109],[123,29,108],
    [125,29,108],[126,30,108],[128,31,107],[129,31,107],[131,32,107],[133,32,106],[134,33,106],[136,33,106],
    [137,34,105],[139,34,105],[141,35,105],[142,36,104],[144,36,104],[145,37,103],[147,37,103],[149,38,102],
    [150,38,102],[152,39,101],[153,40,100],[155,40,100],[156,41,99],[158,41,99],[160,42,98],[161,43,97],
    [163,43,97],[164,44,96],[166,44,95],[167,45,95],[169,46,94],[171,46,93],[172,47,92],[174,48,91],
    [175,49,91],[177,49,90],[178,50,89],[180,51,88],[181,51,87],[183,52,86],[184,53,86],[186,54,85],
    [187,55,84],[189,55,83],[190,56,82],[191,57,81],[193,58,80],[194,59,79],[196,60,78],[197,61,77],
    [199,62,76],[200,62,75],[201,63,74],[203,64,73],[204,65,72],[205,66,71],[207,68,70],[208,69,68],
    [209,70,67],[210,71,66],[212,72,65],[213,73,64],[214,74,63],[215,75,62],[217,77,61],[218,78,59],
    [219,79,58],[220,80,57],[221,82,56],[222,83,55],[223,84,54],[224,86,52],[226,87,51],[227,88,50],
    [228,90,49],[229,91,48],[230,92,46],[230,94,45],[231,95,44],[232,97,43],[233,98,42],[234,100,40],
    [235,101,39],[236,103,38],[237,104,37],[237,106,35],[238,108,34],[239,109,33],[240,111,31],[240,112,30],
    [241,114,29],[242,116,28],[242,117,26],[243,119,25],[243,121,24],[244,122,22],[245,124,21],[245,126,20],
    [246,128,18],[246,129,17],[247,131,16],[247,133,14],[248,135,13],[248,136,12],[248,138,11],[249,140,9],
    [249,142,8],[249,144,8],[250,145,7],[250,147,6],[250,149,6],[250,151,6],[251,153,6],[251,155,6],
    [251,157,6],[251,158,7],[251,160,7],[251,162,8],[251,164,10],[251,166,11],[251,168,13],[251,170,14],
    [251,172,16],[251,174,18],[251,176,20],[251,177,22],[251,179,24],[251,181,26],[251,183,28],[251,185,30],
    [250,187,33],[250,189,35],[250,191,37],[250,193,40],[249,195,42],[249,197,44],[249,199,47],[248,201,49],
    [248,203,52],[248,205,55],[247,207,58],[247,209,60],[246,211,63],[246,213,66],[245,215,69],[245,217,72],
    [244,219,75],[244,220,79],[243,222,82],[243,224,86],[243,226,89],[242,228,93],[242,230,96],[241,232,100],
    [241,233,104],[241,235,108],[241,237,112],[241,238,116],[241,240,121],[241,242,125],[242,243,129],[242,244,133],
    [243,246,137],[244,247,141],[245,248,145],[246,250,149],[247,251,153],[249,252,157],[250,253,160],[252,254,164],
];

